# テキストエディタをつくるメモ

## オーバービュー

### 既存実装をまとめているページ

* [ブラウザベースIDE比較](http://jsrun.it/kyo_ago/hChn)
* [実用的になりつつあるWeb IDEまとめ](https://blog.htmlhifive.com/2016/06/10/useful-web-ide/)

### 難所

* カーソルの座標（文字列長計算）
    * 画面にカーソルを出す位置
    * 画面をクリックしたときの、文字は誰か
* IME 入力
    * 仮の文字列をインライン挿入 (含 注目文節問題）
    * 変換候補リストをカーソル位置に出す）
* クリップボード連携
* スクロール制御

## Pages

* [カーソル位置を計算する](calc_cursor_pos.md)
* [IME の入力](composition_input.md)
* [Elm Nativeモジュールの作り方](how_to_make_native_module.md)
* [マウスでクリックするとカーソルが動くようにする](move_cursor_by_mouse.md)
* [デフォルトのキーボード・ショートカットを殺す](prevent-defalut-keyboard-shortcut.md)
* [elm-make がとてもとても長い問題](problem_time_is_very_long_for_elm-make.md)
* [クリップボードは地獄や](clipboard_is_hell.md)
* [カーソル移動でスクロールを行う](scroll_by_cursor_moving.md)

## TODO

* [x] 機能: カーソル移動（論理）
* [x] 機能: 画面タップでのカーソル移動
* [x] 機能: カーソル表示（表示位置の計算）
* [x] 機能: カーソルの点滅
* [x] 機能: 文字入力 (ASCII)
* [x] 機能: 文字入力（IME) -- 確定時に正しく入力出来る
* [x] 機能: IME 仮入力文字のインライン表示
* [x] 機能: IME 変換候補リストの適切な位置への表示
* [x] 機能: 編集コマンド (Backspace)
* [x] 機能: 編集コマンド (Delete)
* [x] 機能: 範囲選択（論理）
* [ ] 機能: マウスドラッグで範囲選択
* [x] 機能: 範囲選択表示
* [x] 機能: 編集コマンド - 範囲選択 Delete
* [ ] 機能: 編集コマンド - 範囲選択 Backspace
* [x] 機能: 編集コマンド (Copy) クリップボード非対応
* [x] 機能: 編集コマンド (Cut) クリップボード非対応
* [x] 機能: 編集コマンド (Pasete) クリップボード非対応
* [x] 機能: クリップボードへコピー (Ctrl-c, Ctrl-x)
* [x] 機能: クリップボードからペースト (Ctrl-v)
* [ ] 機能: 右クリックメニューから クリップボードへコピー 
* [ ] 機能: 右クリックメニューから クリップボードからペースト
* [x] 機能: キーボード・ショートカット
* [x] 機能: 編集履歴を取る（愚直版）
* [x] 機能: 編集履歴を連続する一つの操作を意味でまとめる
* [x] 機能: Undo
* [ ] 機能: Redo
* [x] 機能: カーソル移動でのスクロール（行）
* [x] 機能: カーソル移動でのスクロール（列）
* [x] 機能: スクロールバーでのスクロール（行）
* [x] 機能: スクロールバーでのスクロール（列）
* [x] リファクタ: NativeのTask (Cmd) 化 
    * 画面クリック時のフォーカスON
    * モディファイヤ押下keydown 時のデフォルトイベント無効化リスナーの登録
* [ ] リファクタ: insert の undo (今はbackspace_procを複数回読んでいる)
* [ ] リファクタ: (アイデア) `type EditTarget = Cursor Pos | Selection Range` 作戦
* [x] 問題: Ctrl なんとかで、ブラウザが持つ元のイベントが発火してしまう（Ctrl-zとか)
    * Elm の `Html/Event` `on` や `onWithOption` だと、keydown のキーにより発火を止めたり素通りさせたり出来ない
* [x] 問題: elm-make がなぜかとてもとても長くかかるようになった
* [ ] 問題: 計算につかった ruler オブジェクトが下の要素（１行目）のクリックを阻害する
    * 中身を消してもダメ
    * left -9999 とかしてもダメ
    * -> これらは確かに表示は画面外に出るが、クリック判定のあるオブジェクトが残ったままになる
* [x] 問題: 範囲選択表示。カーソル行だとCodeレイヤーが上に行ってしまうので、そこだけ文字が黒い
* [ ] 問題: 日本語表示をすると行がずれる問題
* [x] 問題: 空白行を選択しているのが視覚的にわからない
* extra 機能: チャンク（今は「行のリスト」で持っている）
* extra 問題: IME入力で注目文節がわからない (compositionEvent API の限界により）
* extra 表示効率化: 見えないところは描画しない
* [x] 不具合: firefox で カーソルが点滅しない
    * 49.0.2 だったので、focusin / focusout イベントに対応していなかったのが問題だったみたい
    * firefoxのバージョンをあげたら治った
* [x] 不具合: firefox で 日本語入力確定すると、最後の文字が二重になる
* [ ] 不具合: firefox C-c でクリップボードにコピーされない
    * `document.execCommand(‘cut’/‘copy’) はユーザ生成の短期的なイベントハンドラの内部からの呼び出しでないため拒否されました。` とのこと
* [x] 問題: firefox で クリックでのカーソル移動が思い（ワンテンポ遅れる）
    * ...再現しなくなった。なぜ？
* [x] 不具合: firefox で画面クリックでカーソルを移動した時、フォーカスが外れてしまう
    * chromeでは発火していた onclick が発火しないのが原因
    * 常にではない、条件切り分けは出来ていない（ドラッグが発生すると？？を疑っている）
    
